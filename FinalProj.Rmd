---
title: "Insert Title"
author: "Insert Names"
date: "Spring 2018"
runtime: shiny
urlcolor: blue
---

```{r setup, include=FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Final Project

```{r}
#Load libraries
library(readr)
library(rvest)
library(dplyr)
library(ggplot2)
library(caret)
library(shiny)
library(plotly)
library(ggplot2)
library(ggthemes)
library(shinythemes)

```


We only keep variables relevant to the state and that are not missing for any states.

```{r}
#Upload election integrity dataset
election_integrity_full <- read_csv("PEI US 2016 state-level (PEI_US_1.0) 16-12-2017.csv")

election_integrity <- election_integrity_full %>%
  select(stateabbr, PEIIndexi, PEIIndex_rank, PEItype, ratingstate, ratingstate_lci, ratingstate_hci, ratingcountry, ratingcountry_lci, ratingcountry_hci, lawsunfair2, favoredincumbent2, citizens2, lawsi, managed, votinginfo, fairofficials, legalelections, proceduresi, bfavored2, boundariesi, voteregi, oppprevent2, womenopp, minorityopp, leaderselect2, rallies2, partyregi, newspapers, tv2, fairaccess, faircoverage, mediai, donations, rich2, financei, violence2, fraudulent2, easy, choice, postal, expats, internet, rigged2, machinesaccurate, recordssecure, waited2, multiple2, regrestrictive2, popularwill, timely, votingi)

```


```{r}
#Upload voter turnout dataset
voter_turnout <- read_csv("2016 November General Election - Turnout Rates.csv")
voter_turnout <- voter_turnout %>%
  select(State, "VEP_Highest_Office" = "X5", "VAP_Highest_Office" = "X6", "Total_Ballots_Counted_(Estimate)" = "Numerators", "Highest_Office" = "X8", "Voting_Eligible_Population_VEP" = "Denominators", "Voting_Age_Population_VAP" = "X10", "Total_Ineligible_Felons" = "X15", "Abbreviation" = "X17") %>%
  filter(!is.na(State) & State != "United States") %>%
  mutate(Voting_Eligible_Population_VEP = as.numeric(gsub(",", "", as.character(Voting_Eligible_Population_VEP))), Voting_Age_Population_VAP = as.numeric(gsub(",", "", as.character(Voting_Age_Population_VAP))), Total_Ineligible_Felons = as.numeric(gsub(",", "", as.character(Total_Ineligible_Felons)))) %>%
  mutate(Voters_Disenfranchised = Voting_Age_Population_VAP - Voting_Eligible_Population_VEP, Pct_Felon_Disenfranchised = Total_Ineligible_Felons / Voting_Age_Population_VAP) %>%
  select(-State)

  
```

```{r}
#Scrape election results dataset
url <- "https://en.wikipedia.org/wiki/United_States_presidential_election,_2016"
tables <- url %>%
  read_html() %>%
  html_nodes(css = "table") 
election_results <- html_table(tables[[38]], fill = TRUE)
names(election_results) <- c("State", "Voting_Type", "Clinton_Number", "Clinton_Percent", "Clinton_Electoral", "Trump_Number", "Trump_Percent", "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "Abbreviation", "q")
election_results <- election_results %>%
  select(State, Clinton_Percent, Trump_Percent, Abbreviation) %>%
  filter(State != "U.S. Total", State != "Nebraska, 1st", State != "Nebraska, 2nd", State != "Nebraska, 3rd", State != "Maine, 1st", State != "Maine, 2nd", Clinton_Percent != "%")  %>%
  select(-State)

election_results$Abbreviation[election_results$Abbreviation == "ME–a/l"] <- "ME"
election_results$Abbreviation[election_results$Abbreviation == "NE–a/l"] <- "NE"

election_results <- election_results %>% 
  mutate(Clinton_Percent = as.numeric(sub("%", "", as.character(Clinton_Percent))), Trump_Percent = as.numeric(sub("%", "", as.character(Trump_Percent)))) %>%
  mutate(Vote_Clinton = ifelse(Clinton_Percent - Trump_Percent > 0, "Yes", "No"))

```

note inner_join, left_join, and right_join all do the same thing because we are matching 50 states + DC
```{r}
#Merge datasets
integrity_turnout <- inner_join(election_integrity, voter_turnout, by = c("stateabbr" = "Abbreviation"))
all <- inner_join(integrity_turnout, election_results, by = c("stateabbr" = "Abbreviation"))
```

```{r}
#Create a dataset for PCA. Note we only use variables on a scale from 0 to 5
pca_test <- all %>%
  select(-stateabbr, -PEIIndexi, -PEIIndex_rank, -PEItype, -ratingstate, -ratingstate_hci, -ratingstate_lci, -ratingcountry, -ratingcountry_lci, -ratingcountry_hci, -lawsi, -proceduresi, -boundariesi, -voteregi, -partyregi, -mediai, -financei, -VEP_Highest_Office, -VAP_Highest_Office, -`Total_Ballots_Counted_(Estimate)`, -Highest_Office, -Voting_Eligible_Population_VEP, -Voting_Age_Population_VAP, -Total_Ineligible_Felons, -Voters_Disenfranchised, -Clinton_Percent, -Trump_Percent, -Vote_Clinton, -votingi, -Pct_Felon_Disenfranchised)

#Run principle components
prin_comp <- prcomp(pca_test, scale. = T)

#Create variables necessary to explain amount of variance explained by various principal components
std_dev <- prin_comp$sdev
pr_var <- std_dev^2
prop_varex <- pr_var/sum(pr_var)

#Plot cumulative variance explained by principal components
plot(cumsum(prop_varex), xlab = "Principal Component",
              ylab = "Cumulative Proportion of Variance Explained",
              type = "b")

#Plot marginal variance explained by principal components
plot(prop_varex, xlab = "Principal Component",
             ylab = "Proportion of Variance Explained",
             type = "b")

#Create a data frame with state, index, whether the state voted for Trump or Clinton, and the principal components
all_with_pca <- data.frame(state = all$stateabbr, index = all$PEIIndexi, clinton = all$Vote_Clinton, prin_comp$x) 

#Plot PC1 against index variable
ggplot(all_with_pca, aes(x= index, y=PC1)) +
  geom_point(aes(col = clinton)) + 
  labs(x = "Election Integrity Index (Imputed)") +
  scale_color_manual(labels = c("Trump", "Clinton"), values = c("firebrick3", "royalblue2"), name = "Who Won the State?") +
  theme_classic() +
  theme(legend.position = c(.80,.85), legend.box.background = element_rect())

#Plot PC1 against PC2
ggplot(all_with_pca, aes(x= PC2, y=PC1, color = as.factor(clinton))) +
  geom_point() +
  scale_color_manual(labels = c("Trump", "Clinton"), values = c("firebrick3", "royalblue2"), name = "Who Won the State?") +
  theme_classic() +
  theme(legend.position = c(.17,.80), legend.box.background = element_rect())

#Set cross validation options
cv_opts <- trainControl(method = "cv", number = 51)

#Set seed
set.seed(10)

#Build the model only using the index variable
log_model1 <- train(clinton ~ index,  data=all_with_pca, method="glm", family="binomial",trControl = cv_opts)

#Build the model using first 6 principal components
log_model2 <- train(clinton ~ PC1 + PC2 + PC3 + PC4 + PC5,  data=all_with_pca, method="glm", family="binomial",trControl = cv_opts)

#Print out accuracy of models 1 and 2
log_model1
log_model2
```

From the PCA, we saw that it was possible for the PEIIndex to predict the outcome of an election. We wanted to test this out on a real life case study, and what better election to use than the highly contentious 2016 presidential election! Democrats frequently argue that Republicans pass laws to disenfranchise voters more likely to vote Democrat, giving them a greater chance that they'll win more elections. In this next section we will try to use the results the 2016 presidential election to gauge how much weight, if any, this argument has.
```{r}
#Creating a dataset with all the variables from election_integrity that couldn't be used for PCA because of missing values.
plots <- left_join(election_integrity_full, all)
#Getting a sense of voter access
ggplot(plots, aes(x = Pct_Felon_Disenfranchised, y = PEIIndexi, color = Vote_Clinton)) +
  geom_point() +
  labs(y = "Election Integrity Index (Imputed)", x = "Dienfranchised Felons (% of total eligible pop.)") +
  scale_color_manual(labels = c("Trump", "Clinton"), values = c("firebrick3", "royalblue2"), name = "Who Won the State?") +
  theme_classic() +
  theme(legend.position = c(.85,.80), legend.box.background = element_rect())

ggplot(plots, aes(x = Vote_Clinton, y = Pct_Felon_Disenfranchised)) +
  geom_boxplot()+
  labs(x = "Who won the state?", y = "Dienfranchised Felons (% of total eligible pop.)") +
  theme_classic()
```

```{r}
ggplot(plots, aes(x = Vote_Clinton, y = boundariesi)) + 
  geom_boxplot() +
  labs(x = "Who won the state?", y = "Boundaries Integrity Index (Imputed)") +
  theme_classic()
```

```{r}
#NEED TO BE CAREFUL ABOUT INTERPRETATION BECAUSE 2 ---> reverse coded
ggplot(plots, aes(x = Vote_Clinton, y = citizens2)) +
  geom_boxplot() +
  labs(x = "Who won the state?", y = "citizens2") +
  theme_classic()
```

```{r}
#NEED TO BE CAREFUL ABOUT INTERPRETATION BECAUSE 2 ---> reverse coded
#Are there more illegal voters for Democrats?
ggplot(plots, aes(x = Vote_Clinton, y = ineligible2)) +
  geom_boxplot() +
  labs(x = "Who won the state?", y = "ineligible2") +
  theme_classic()
```


```{r}
#Shiny app


#Nice Labels
x_label <- data.frame(var = c("PEIIndexi", "lawsi", "proceduresi", "boundariesi", "voteregi", "partyregi", "mediai", "financei", "votingi", "Pct_Felon_Disenfranchised"), names = c("Overall Election Integrity Index (Imputed)", "Legal Integrity Index (Imputed)", "Procedures Integrity Index (Imputed)", "Boundaries Integrity Index (Imputed)", "Voter Registration Integrity Index (Imputed)", "Party Registration Integrity Index (Imputed)", "Media Coverage Integrity Index (Imputed)", "Campaign Finance Integrity Index (Imputed)", "Voting Integrity Index (Imputed)", "Dienfranchised Felons (% of total eligible pop.)"))
                      
y_label <- data.frame(var = c("PEIIndexi", "lawsi", "proceduresi", "boundariesi", "voteregi", "partyregi", "mediai", "financei", "votingi", "Pct_Felon_Disenfranchised"), names = c("Overall Election Integrity Index (Imputed)", "Legal Integrity Index (Imputed)", "Procedures Integrity Index (Imputed)", "Boundaries Integrity Index (Imputed)", "Voter Registration Integrity Index (Imputed)", "Party Registration Integrity Index (Imputed)", "Media Coverage Integrity Index (Imputed)", "Campaign Finance Integrity Index (Imputed)", "Voting Integrity Index (Imputed)", "Dienfranchised Felons (% of total eligible pop.)"))


all_quant <- all %>%
  select(stateabbr, Vote_Clinton, PEIIndexi, lawsi, proceduresi, boundariesi, voteregi, partyregi, mediai, financei, votingi, Pct_Felon_Disenfranchised) 

all_qual <- all %>%
  select(stateabbr, Vote_Clinton, lawsunfair2, favoredincumbent2, citizens2, managed, votinginfo, fairofficials, legalelections, bfavored2, oppprevent2, womenopp, minorityopp, leaderselect2, rallies2, newspapers, tv2, fairaccess, faircoverage, donations, rich2, violence2, fraudulent2, easy, choice, postal, expats, internet, rigged2, machinesaccurate, recordssecure, waited2, multiple2, regrestrictive2, popularwill, timely)


##### UI Side ######
ui <- navbarPage(
  shinythemes::themeSelector(),
  tabPanel("Quantitative Variables",
    plotlyOutput("quant"),
  
  hr(),
  fluidRow(
    column(5,
      selectInput("x", "X-Axis", 
                 c("Overall Election Integrity Index (Imputed)" = "PEIIndexi", 
                  "Legal Integrity Index (Imputed)" = "lawsi", 
                  "Procedures Integrity Index (Imputed)" = "proceduresi", 
                  "Boundaries Integrity Index (Imputed)" = "boundariesi",
                  "Voter Registration Integrity Index (Imputed)" = "voteregi", 
                  "Party Registration Integrity Index (Imputed)" = "partyregi", 
                  "Media Coverage Integrity Index (Imputed)" = "mediai", 
                  "Campaign Finance Integrity Index (Imputed)" = "financei", 
                  "Voting Integrity Index (Imputed)" = "votingi")),
    
      selectInput(inputId = "y", "Y-Axis",
                  c("Overall Election Integrity Index (Imputed)" = "PEIIndexi", 
                  "Legal Integrity Index (Imputed)" = "lawsi", 
                  "Procedures Integrity Index (Imputed)" = "proceduresi", 
                  "Boundaries Integrity Index (Imputed)" = "boundariesi",
                  "Voter Registration Integrity Index (Imputed)" = "voteregi", 
                  "Party Registration Integrity Index (Imputed)" = "partyregi", 
                  "Media Coverage Integrity Index (Imputed)" = "mediai", 
                  "Campaign Finance Integrity Index (Imputed)" = "financei", 
                  "Voting Integrity Index (Imputed)" = "votingi"))
    ),
    column(2,
      checkboxGroupInput("candidate", "Candidate Chosen", 
                         choices = list("Clinton" = "Yes", "Trump" = "No"),
                         selected = unique(all_quant$Vote_Clinton))
            ),
    column(5,
      selectInput("state", "What state do you want to see?",
                  choices = unique(all_quant$stateabbr))
           )
  ),
  
  fluidRow(
    h3("Variable Key")
  )
),

  tabPanel("Categorical Variables",
    plotlyOutput("qual"),
      
  hr(),
  
  fluidRow(
    column(5,
      selectInput("x2", "X-Axis", names(all_qual)[3:34]),
      selectInput("y2", "Y-Axis", names(all_qual)[3:34], names(all_qual)[4])
    ),
    column(2,
      checkboxGroupInput("candidate2", "Candidate Chosen", 
                         choices = list("Clinton" = "Yes", "Trump" = "No"),
                         selected = unique(all_qual$Vote_Clinton))
            ),
    column(5,
      selectInput("state2", "What state do you want to see?",
                  choices = unique(all_qual$stateabbr))
           )
  ),
  
  fluidRow(
    h3("Variable Key"),
  p(tags$b("Note:"), "For all these variables, experts were asked to rate the various states on a scale of 1-5 based on various statements, with 1 being strongly agree and 5 being strongly disagree, which is why we called them categorical. However, all the experts' ratings were averaged, allowing them to be plotted as quantitative.")
  )
  )
)

##### Server Side #####
server <- function(input, output) {
  
  #Label names
  xlab_var_name <- reactive({
    filter(x_label, var == input$x) %>%
    select(names) #.$names
  })
  
  ylab_var_name <- reactive({
    y_label %>%
    filter(var == input$y) %>%
    select(names) #.$names
  })
  
  output$quant <- renderPlotly({
    req(input$candidate)
    all_reactive <- filter(all_quant, Vote_Clinton %in% input$candidate)
    state_reactive <- filter(all_quant, stateabbr %in% input$state)
    ggplot(all_reactive, aes(color = Vote_Clinton, "State" = stateabbr)) +
      geom_point(alpha =.80, aes_string(x = input$x, y = input$y)) +
      geom_text(data = state_reactive, mapping = aes_string(x = input$x, y = input$y), label = input$state) +
      scale_color_manual(values = c("firebrick3", "royalblue2"), breaks = c("Trump", "Clinton"), name = "") +
      theme_classic() +
      labs(x = as.character(xlab_var_name()[1,1]), y = as.character(ylab_var_name()[1,1])) +
      theme(legend.position = c(.80,.85), legend.box.background = element_rect()) + 
      coord_cartesian(xlim = c(0, 100), ylim = c(0, 100))
  })
  
    output$qual <- renderPlotly({
    req(input$candidate2)
    reactive_all <- filter(all_qual, Vote_Clinton %in% input$candidate2)
    reactive_state <- filter(all_qual, stateabbr %in% input$state2)
    ggplot(reactive_all, aes(color = Vote_Clinton, "State" = stateabbr)) +
      geom_point(alpha =.80, aes_string(x = input$x2, y = input$y2)) +
      geom_text(data = reactive_state, mapping = aes_string(x = input$x2, y = input$y2), label = input$state2) + 
      scale_color_manual(values = c("firebrick3", "royalblue2"), labels = c("Trump", "Clinton"), name = "") +
      theme_classic() + 
      coord_cartesian(xlim = c(0, 5), ylim = c(0, 5))
  })
}

shinyApp(ui, server)
```





